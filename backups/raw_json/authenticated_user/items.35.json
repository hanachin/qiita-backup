[{"rendered_body":"\u003cp\u003eRubyの初期化について昔調べたので書きます。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"rubyのtop-selfあるいはmainオブジェクトについて\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#ruby%E3%81%AEtop-self%E3%81%82%E3%82%8B%E3%81%84%E3%81%AFmain%E3%82%AA%E3%83%96%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eRubyのtop self、あるいはmainオブジェクトについて\u003c/h2\u003e\n\n\u003cp\u003e琉球大学の学生(\u003ca href=\"https://twitter.com/_atton\" rel=\"nofollow noopener\" target=\"_blank\"\u003e@_attonさん\u003c/a\u003e)が立ち上げたGitHubのOrganization、ie-developersに以下の質問が立っていた。\u003c/p\u003e\n\n\u003cp\u003e個人的にも気になっていたので色々な実装を読んでいた。\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://github.com/ie-developers/ie-questions/issues/8\" rel=\"nofollow noopener\" target=\"_blank\"\u003emainオブジェクト · Issue #8 · ie-developers/ie-questions\u003c/a\u003e\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"mri\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#mri\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eMRI\u003c/h2\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"c\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003cspan class=\"kt\"\u003evoid\u003c/span\u003e\n\u003cspan class=\"nf\"\u003eInit_top_self\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003evoid\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"n\"\u003erb_vm_t\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003evm\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eGET_VM\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003evm\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003etop_self\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003erb_obj_alloc\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003erb_cObject\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"n\"\u003erb_define_singleton_method\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003erb_vm_top_self\u003c/span\u003e\u003cspan class=\"p\"\u003e(),\u003c/span\u003e \u003cspan class=\"s\"\u003e\"to_s\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003emain_to_s\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"n\"\u003erb_define_alias\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003erb_singleton_class\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003erb_vm_top_self\u003c/span\u003e\u003cspan class=\"p\"\u003e()),\u003c/span\u003e \u003cspan class=\"s\"\u003e\"inspect\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\"to_s\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n    \u003cspan class=\"cm\"\u003e/* initialize mark object array, hash */\u003c/span\u003e\n    \u003cspan class=\"n\"\u003evm\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003emark_object_ary\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003erb_ary_tmp_new\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e\u003ca href=\"https://github.com/ruby/ruby/blob/v2_1_5/vm.c#L2836,L2838\" class=\"autolink\" rel=\"nofollow noopener\" target=\"_blank\"\u003ehttps://github.com/ruby/ruby/blob/v2_1_5/vm.c#L2836,L2838\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eCRubyでは\u003ccode\u003eInit_\u003c/code\u003eのプレフィックスがついているものは初期化時によばれる。\u003cbr\u003e\nRuby界でのクラスはCではだいたい\u003ccode\u003erb_c\u003c/code\u003eのプレフィックスがついている。\u003cbr\u003e\nRubyのメソッドはCレベルでは\u003ccode\u003erb_\u0026lt;ここにクラス名\u0026gt;_\u0026lt;メソッド名\u0026gt;\u003c/code\u003eみたいになってることが多い。\u003cbr\u003e\nトップレベルで\u003cbr\u003e\n\u003ccode\u003eruby\u003cbr\u003e\nputs self\u003cbr\u003e\n\u003c/code\u003e\u003cbr\u003e\nしたときの動作もこれをみれば一目瞭然ですね。\u003c/p\u003e\n\n\u003cp\u003e起動まではたぶんusaさんのブログでめっちゃ書かれてる\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"http://www.garbagecollect.jp/~usa/d/201411c.html#id20141130_P1\" class=\"autolink\" rel=\"nofollow noopener\" target=\"_blank\"\u003ehttp://www.garbagecollect.jp/~usa/d/201411c.html#id20141130_P1\u003c/a\u003e\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"rubinius\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#rubinius\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eRubinius\u003c/h2\u003e\n\n\u003cp\u003eかいつまむとこのあたり。コメントから溢れ出る天地創造感。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"c\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e  \u003cspan class=\"cm\"\u003e/* Creates the rubinius object universe from scratch. */\u003c/span\u003e\n  \u003cspan class=\"kt\"\u003evoid\u003c/span\u003e \u003cspan class=\"n\"\u003eVM\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003ebootstrap_ontology\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eSTATE\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"cm\"\u003e/* (中略) */\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eObject\u003c/span\u003e\u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003emain\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003enew_object\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eObject\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eG\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eobject\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eGO\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003emain\u003c/span\u003e\u003cspan class=\"p\"\u003e).\u003c/span\u003e\u003cspan class=\"n\"\u003eset\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003emain\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eG\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eobject\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eset_const\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003estate\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\"MAIN\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003emain\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e \u003cspan class=\"c1\"\u003e// HACK test hooking up MAIN\u003c/span\u003e\n    \u003cspan class=\"cm\"\u003e/* (後略) */\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e\u003ca href=\"https://github.com/rubinius/rubinius/blob/v2.4.0/vm/ontology.cpp#L404,L406\" class=\"autolink\" rel=\"nofollow noopener\" target=\"_blank\"\u003ehttps://github.com/rubinius/rubinius/blob/v2.4.0/vm/ontology.cpp#L404,L406\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eたどるとこんな感じ。環境があって、状態があって、そこに世界がハマる。\u003cbr\u003e\n\u003ca href=\"https://github.com/rubinius/rubinius/blob/v2.4.0/vm/vm.cpp#L134\" class=\"autolink\" rel=\"nofollow noopener\" target=\"_blank\"\u003ehttps://github.com/rubinius/rubinius/blob/v2.4.0/vm/vm.cpp#L134\u003c/a\u003e\u003cbr\u003e\n\u003ca href=\"https://github.com/rubinius/rubinius/blob/v2.4.0/vm/environment.cpp#L460\" class=\"autolink\" rel=\"nofollow noopener\" target=\"_blank\"\u003ehttps://github.com/rubinius/rubinius/blob/v2.4.0/vm/environment.cpp#L460\u003c/a\u003e\u003cbr\u003e\n\u003ca href=\"https://github.com/rubinius/rubinius/blob/v2.4.0/vm/environment.cpp#L800\" class=\"autolink\" rel=\"nofollow noopener\" target=\"_blank\"\u003ehttps://github.com/rubinius/rubinius/blob/v2.4.0/vm/environment.cpp#L800\u003c/a\u003e\u003cbr\u003e\n\u003ca href=\"https://github.com/rubinius/rubinius/blob/v2.4.0/vm/drivers/cli.cpp#L55\" class=\"autolink\" rel=\"nofollow noopener\" target=\"_blank\"\u003ehttps://github.com/rubinius/rubinius/blob/v2.4.0/vm/drivers/cli.cpp#L55\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003emainオブジェクト自体の定義はこのあたり。\u003cbr\u003e\n世界を作る際に定数としてMAINが作られていてそこに足される感じですね。\u003cbr\u003e\n\u003ca href=\"https://github.com/rubinius/rubinius/blob/v2.4.0/kernel/common/main.rb\" class=\"autolink\" rel=\"nofollow noopener\" target=\"_blank\"\u003ehttps://github.com/rubinius/rubinius/blob/v2.4.0/kernel/common/main.rb\u003c/a\u003e\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"jruby\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#jruby\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eJRuby\u003c/h2\u003e\n\n\u003cp\u003e実装がいくつかある。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"truffle\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#truffle\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eTruffle\u003c/h3\u003e\n\n\u003cp\u003eTruffleについては以下\u003cbr\u003e\n\u003ca href=\"https://github.com/jruby/jruby/wiki/Truffle\" class=\"autolink\" rel=\"nofollow noopener\" target=\"_blank\"\u003ehttps://github.com/jruby/jruby/wiki/Truffle\u003c/a\u003e\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"java\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003cspan class=\"c1\"\u003e// CoreLibraryのinitializeの中\u003c/span\u003e\n\u003cspan class=\"n\"\u003emainObject\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"n\"\u003eRubyBasicObject\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eobjectClass\u003c/span\u003e\u003cspan class=\"o\"\u003e);\u003c/span\u003e\n\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e\u003ca href=\"https://github.com/jruby/jruby/blob/f66d751a35e8dda462489a6d402114b2e42d1c40/core/src/main/java/org/jruby/truffle/runtime/core/CoreLibrary.java#L268\" class=\"autolink\" rel=\"nofollow noopener\" target=\"_blank\"\u003ehttps://github.com/jruby/jruby/blob/f66d751a35e8dda462489a6d402114b2e42d1c40/core/src/main/java/org/jruby/truffle/runtime/core/CoreLibrary.java#L268\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eたどると\u003cbr\u003e\n\u003ca href=\"https://github.com/jruby/jruby/blob/f66d751a35e8dda462489a6d402114b2e42d1c40/core/src/main/java/org/jruby/truffle/runtime/RubyContext.java#L94\" class=\"autolink\" rel=\"nofollow noopener\" target=\"_blank\"\u003ehttps://github.com/jruby/jruby/blob/f66d751a35e8dda462489a6d402114b2e42d1c40/core/src/main/java/org/jruby/truffle/runtime/RubyContext.java#L94\u003c/a\u003e\u003cbr\u003e\n\u003ca href=\"https://github.com/jruby/jruby/blob/f66d751a35e8dda462489a6d402114b2e42d1c40/core/src/main/java/org/jruby/truffle/TruffleBridgeImpl.java#L48\" class=\"autolink\" rel=\"nofollow noopener\" target=\"_blank\"\u003ehttps://github.com/jruby/jruby/blob/f66d751a35e8dda462489a6d402114b2e42d1c40/core/src/main/java/org/jruby/truffle/TruffleBridgeImpl.java#L48\u003c/a\u003e\u003cbr\u003e\n\u003ca href=\"https://github.com/jruby/jruby/blob/f66d751a35e8dda462489a6d402114b2e42d1c40/core/src/main/java/org/jruby/Ruby.java#L899,L900\" class=\"autolink\" rel=\"nofollow noopener\" target=\"_blank\"\u003ehttps://github.com/jruby/jruby/blob/f66d751a35e8dda462489a6d402114b2e42d1c40/core/src/main/java/org/jruby/Ruby.java#L899,L900\u003c/a\u003e\u003cbr\u003e\n\u003ca href=\"https://github.com/jruby/jruby/blob/f66d751a35e8dda462489a6d402114b2e42d1c40/core/src/main/java/org/jruby/Ruby.java#L831\" class=\"autolink\" rel=\"nofollow noopener\" target=\"_blank\"\u003ehttps://github.com/jruby/jruby/blob/f66d751a35e8dda462489a6d402114b2e42d1c40/core/src/main/java/org/jruby/Ruby.java#L831\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003e(略)\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://github.com/jruby/jruby/blob/f66d751a35e8dda462489a6d402114b2e42d1c40/core/src/main/java/org/jruby/Main.java\" class=\"autolink\" rel=\"nofollow noopener\" target=\"_blank\"\u003ehttps://github.com/jruby/jruby/blob/f66d751a35e8dda462489a6d402114b2e42d1c40/core/src/main/java/org/jruby/Main.java\u003c/a\u003e\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"truffleじゃないほう\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#truffle%E3%81%98%E3%82%83%E3%81%AA%E3%81%84%E3%81%BB%E3%81%86\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eTruffleじゃないほう\u003c/h3\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"java\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e    \u003cspan class=\"kd\"\u003eprivate\u003c/span\u003e \u003cspan class=\"kt\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003einitRoot\u003c/span\u003e\u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e// Object is ready, create top self\u003c/span\u003e\n        \u003cspan class=\"n\"\u003etopSelf\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eTopSelfFactory\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003ecreateTopSelf\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"o\"\u003e);\u003c/span\u003e\n\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e\u003ca href=\"https://github.com/jruby/jruby/blob/f66d751a35e8dda462489a6d402114b2e42d1c40/core/src/main/java/org/jruby/Ruby.java#L1365\" class=\"autolink\" rel=\"nofollow noopener\" target=\"_blank\"\u003ehttps://github.com/jruby/jruby/blob/f66d751a35e8dda462489a6d402114b2e42d1c40/core/src/main/java/org/jruby/Ruby.java#L1365\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003e\u003ccode\u003eRuby. newInstance\u003c/code\u003eでインスタンスができ、そのときinit、initRootとよばれtopSelfがうまれる。\u003cbr\u003e\n\u003ca href=\"https://github.com/jruby/jruby/blob/f66d751a35e8dda462489a6d402114b2e42d1c40/core/src/main/java/org/jruby/Ruby.java#L1199\" class=\"autolink\" rel=\"nofollow noopener\" target=\"_blank\"\u003ehttps://github.com/jruby/jruby/blob/f66d751a35e8dda462489a6d402114b2e42d1c40/core/src/main/java/org/jruby/Ruby.java#L1199\u003c/a\u003e\u003cbr\u003e\n\u003ca href=\"https://github.com/jruby/jruby/blob/f66d751a35e8dda462489a6d402114b2e42d1c40/core/src/main/java/org/jruby/Ruby.java#L315\" class=\"autolink\" rel=\"nofollow noopener\" target=\"_blank\"\u003ehttps://github.com/jruby/jruby/blob/f66d751a35e8dda462489a6d402114b2e42d1c40/core/src/main/java/org/jruby/Ruby.java#L315\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003e(略)\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://github.com/jruby/jruby/blob/f66d751a35e8dda462489a6d402114b2e42d1c40/core/src/main/java/org/jruby/Main.java\" class=\"autolink\" rel=\"nofollow noopener\" target=\"_blank\"\u003ehttps://github.com/jruby/jruby/blob/f66d751a35e8dda462489a6d402114b2e42d1c40/core/src/main/java/org/jruby/Main.java\u003c/a\u003e\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"mruby\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#mruby\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eMRuby\u003c/h2\u003e\n\n\u003cp\u003eMRubyだけめっちゃ新鮮で、topselfあるかないかチェックしてないときだけ初期化してる。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"c\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003cspan class=\"n\"\u003eMRB_API\u003c/span\u003e \u003cspan class=\"n\"\u003emrb_value\u003c/span\u003e\n\u003cspan class=\"nf\"\u003emrb_top_self\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003emrb_state\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003emrb\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e!\u003c/span\u003e\u003cspan class=\"n\"\u003emrb\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003etop_self\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"n\"\u003emrb\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003etop_self\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003eRObject\u003c/span\u003e\u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"n\"\u003emrb_obj_alloc\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003emrb\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eMRB_TT_OBJECT\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003emrb\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eobject_class\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"n\"\u003emrb_define_singleton_method\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003emrb\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003emrb\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003etop_self\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\"inspect\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003einspect_main\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eMRB_ARGS_NONE\u003c/span\u003e\u003cspan class=\"p\"\u003e());\u003c/span\u003e\n    \u003cspan class=\"n\"\u003emrb_define_singleton_method\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003emrb\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003emrb\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003etop_self\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\"to_s\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003einspect_main\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eMRB_ARGS_NONE\u003c/span\u003e\u003cspan class=\"p\"\u003e());\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n  \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003emrb_obj_value\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003emrb\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003etop_self\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e\u003ca href=\"https://github.com/mruby/mruby/blob/master/src/state.c#L272,L281\" class=\"autolink\" rel=\"nofollow noopener\" target=\"_blank\"\u003ehttps://github.com/mruby/mruby/blob/master/src/state.c#L272,L281\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eたぶん\u003ccode\u003emrb_state\u003c/code\u003eは使い回されるんだろうな。で毎回初期化処理は通るんだけどすでに初期化されていればなにもしない、みたいな。\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://github.com/mruby/mruby/blob/09c6ca936c965d63752276aa3203b3e7534874ae/src/vm.c#L2379,L2402\" class=\"autolink\" rel=\"nofollow noopener\" target=\"_blank\"\u003ehttps://github.com/mruby/mruby/blob/09c6ca936c965d63752276aa3203b3e7534874ae/src/vm.c#L2379,L2402\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eこのコミットでなんかスタックの位置保存するみたいなやつはいってて、stack_keepの分だけさすスタック伸ばしてから実行してるっぽい(くわしくはしらない)\u003cbr\u003e\n\u003ca href=\"https://github.com/mruby/mruby/commit/6bf1ee78c8cdc5c1b0265694c404ada0ec32cb28\" class=\"autolink\" rel=\"nofollow noopener\" target=\"_blank\"\u003ehttps://github.com/mruby/mruby/commit/6bf1ee78c8cdc5c1b0265694c404ada0ec32cb28\u003c/a\u003e\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"まとめ\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%81%BE%E3%81%A8%E3%82%81\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eまとめ\u003c/h2\u003e\n\n\u003cp\u003eRuby実装いっぱいあって面白い\u003c/p\u003e\n","body":"Rubyの初期化について昔調べたので書きます。\n\n## Rubyのtop self、あるいはmainオブジェクトについて\n\n琉球大学の学生([@_attonさん](https://twitter.com/_atton))が立ち上げたGitHubのOrganization、ie-developersに以下の質問が立っていた。\n\n個人的にも気になっていたので色々な実装を読んでいた。\n\n[mainオブジェクト · Issue #8 · ie-developers/ie-questions](https://github.com/ie-developers/ie-questions/issues/8)\n\n## MRI\n\n``` c\nvoid\nInit_top_self(void)\n{\n    rb_vm_t *vm = GET_VM();\n\n    vm-\u003etop_self = rb_obj_alloc(rb_cObject);\n    rb_define_singleton_method(rb_vm_top_self(), \"to_s\", main_to_s, 0);\n    rb_define_alias(rb_singleton_class(rb_vm_top_self()), \"inspect\", \"to_s\");\n\n    /* initialize mark object array, hash */\n    vm-\u003emark_object_ary = rb_ary_tmp_new(1);\n}\n```\n\nhttps://github.com/ruby/ruby/blob/v2_1_5/vm.c#L2836,L2838\n\nCRubyでは`Init_`のプレフィックスがついているものは初期化時によばれる。\nRuby界でのクラスはCではだいたい`rb_c`のプレフィックスがついている。\nRubyのメソッドはCレベルでは`rb_\u003cここにクラス名\u003e_\u003cメソッド名\u003e`みたいになってることが多い。\nトップレベルで\n``` ruby\nputs self\n```\nしたときの動作もこれをみれば一目瞭然ですね。\n\n起動まではたぶんusaさんのブログでめっちゃ書かれてる\n\nhttp://www.garbagecollect.jp/~usa/d/201411c.html#id20141130_P1\n\n## Rubinius\n\nかいつまむとこのあたり。コメントから溢れ出る天地創造感。\n\n``` c\n  /* Creates the rubinius object universe from scratch. */\n  void VM::bootstrap_ontology(STATE) {\n    /* (中略) */\n    Object* main = new_object\u003cObject\u003e(G(object));\n    GO(main).set(main);\n    G(object)-\u003eset_const(state, \"MAIN\", main); // HACK test hooking up MAIN\n    /* (後略) */\n  }\n```\nhttps://github.com/rubinius/rubinius/blob/v2.4.0/vm/ontology.cpp#L404,L406\n\nたどるとこんな感じ。環境があって、状態があって、そこに世界がハマる。\nhttps://github.com/rubinius/rubinius/blob/v2.4.0/vm/vm.cpp#L134\nhttps://github.com/rubinius/rubinius/blob/v2.4.0/vm/environment.cpp#L460\nhttps://github.com/rubinius/rubinius/blob/v2.4.0/vm/environment.cpp#L800\nhttps://github.com/rubinius/rubinius/blob/v2.4.0/vm/drivers/cli.cpp#L55\n\nmainオブジェクト自体の定義はこのあたり。\n世界を作る際に定数としてMAINが作られていてそこに足される感じですね。\nhttps://github.com/rubinius/rubinius/blob/v2.4.0/kernel/common/main.rb\n\n## JRuby\n実装がいくつかある。\n\n### Truffle\nTruffleについては以下\nhttps://github.com/jruby/jruby/wiki/Truffle\n\n``` java\n// CoreLibraryのinitializeの中\nmainObject = new RubyBasicObject(objectClass);\n```\nhttps://github.com/jruby/jruby/blob/f66d751a35e8dda462489a6d402114b2e42d1c40/core/src/main/java/org/jruby/truffle/runtime/core/CoreLibrary.java#L268\n\nたどると\nhttps://github.com/jruby/jruby/blob/f66d751a35e8dda462489a6d402114b2e42d1c40/core/src/main/java/org/jruby/truffle/runtime/RubyContext.java#L94\nhttps://github.com/jruby/jruby/blob/f66d751a35e8dda462489a6d402114b2e42d1c40/core/src/main/java/org/jruby/truffle/TruffleBridgeImpl.java#L48\nhttps://github.com/jruby/jruby/blob/f66d751a35e8dda462489a6d402114b2e42d1c40/core/src/main/java/org/jruby/Ruby.java#L899,L900\nhttps://github.com/jruby/jruby/blob/f66d751a35e8dda462489a6d402114b2e42d1c40/core/src/main/java/org/jruby/Ruby.java#L831\n\n(略)\n\nhttps://github.com/jruby/jruby/blob/f66d751a35e8dda462489a6d402114b2e42d1c40/core/src/main/java/org/jruby/Main.java\n\n### Truffleじゃないほう\n``` java\n    private void initRoot() {\n        // Object is ready, create top self\n        topSelf = TopSelfFactory.createTopSelf(this);\n```\nhttps://github.com/jruby/jruby/blob/f66d751a35e8dda462489a6d402114b2e42d1c40/core/src/main/java/org/jruby/Ruby.java#L1365\n\n`Ruby. newInstance`でインスタンスができ、そのときinit、initRootとよばれtopSelfがうまれる。\nhttps://github.com/jruby/jruby/blob/f66d751a35e8dda462489a6d402114b2e42d1c40/core/src/main/java/org/jruby/Ruby.java#L1199\nhttps://github.com/jruby/jruby/blob/f66d751a35e8dda462489a6d402114b2e42d1c40/core/src/main/java/org/jruby/Ruby.java#L315\n\n(略)\n\nhttps://github.com/jruby/jruby/blob/f66d751a35e8dda462489a6d402114b2e42d1c40/core/src/main/java/org/jruby/Main.java\n\n## MRuby\nMRubyだけめっちゃ新鮮で、topselfあるかないかチェックしてないときだけ初期化してる。\n\n``` c\nMRB_API mrb_value\nmrb_top_self(mrb_state *mrb)\n{\n  if (!mrb-\u003etop_self) {\n    mrb-\u003etop_self = (struct RObject*)mrb_obj_alloc(mrb, MRB_TT_OBJECT, mrb-\u003eobject_class);\n    mrb_define_singleton_method(mrb, mrb-\u003etop_self, \"inspect\", inspect_main, MRB_ARGS_NONE());\n    mrb_define_singleton_method(mrb, mrb-\u003etop_self, \"to_s\", inspect_main, MRB_ARGS_NONE());\n  }\n  return mrb_obj_value(mrb-\u003etop_self);\n}\n```\nhttps://github.com/mruby/mruby/blob/master/src/state.c#L272,L281\n\nたぶん`mrb_state`は使い回されるんだろうな。で毎回初期化処理は通るんだけどすでに初期化されていればなにもしない、みたいな。\n\nhttps://github.com/mruby/mruby/blob/09c6ca936c965d63752276aa3203b3e7534874ae/src/vm.c#L2379,L2402\n\nこのコミットでなんかスタックの位置保存するみたいなやつはいってて、stack_keepの分だけさすスタック伸ばしてから実行してるっぽい(くわしくはしらない)\nhttps://github.com/mruby/mruby/commit/6bf1ee78c8cdc5c1b0265694c404ada0ec32cb28\n\n## まとめ\nRuby実装いっぱいあって面白い\n","coediting":false,"comments_count":0,"created_at":"2017-09-21T01:05:06+09:00","group":null,"id":"f70d7fd9ec3e9cb5a821","likes_count":4,"private":false,"reactions_count":0,"tags":[{"name":"Ruby","versions":[]}],"title":"Rubyのtop self、あるいはmainオブジェクトについて","updated_at":"2017-09-21T01:05:06+09:00","url":"https://qiita.com/hanachin_/items/f70d7fd9ec3e9cb5a821","user":{"description":"既婚バイ","facebook_id":"seiei.higa","followees_count":166,"followers_count":120,"github_login_name":"hanachin","id":"hanachin_","items_count":55,"linkedin_id":"","location":"Naha, Okinawa, Japan","name":"Seiei Miyagi","organization":"YassLab","permanent_id":2074,"profile_image_url":"https://qiita-image-store.s3.amazonaws.com/0/2074/profile-images/1511092027","twitter_screen_name":"hanachin_","website_url":""},"page_views_count":null}]